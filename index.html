<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>球球联动限定抽奖</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF6B6B',
            secondary: '#4ECDC4',
            accent: '#FFD166',
            light: '#F7FFF7',
            dark: '#2A2D34'
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .prize-card { @apply w-full aspect-square rounded-lg bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center text-center p-2 transition-all duration-200 hover:scale-105 shadow-md; }
      .spin-btn { @apply w-24 h-24 rounded-full bg-primary text-white font-bold text-xl flex items-center justify-center shadow-lg hover:bg-primary/90 transition-all duration-300 transform hover:scale-105; }
      .spin-btn:disabled { @apply bg-gray-400 cursor-not-allowed hover:bg-gray-400 hover:scale-100; }
      .result-card { @apply bg-white/90 backdrop-blur-md rounded-xl p-6 text-center shadow-xl; }
      .history-item { @apply flex items-center justify-between p-3 border-b border-gray-200; }
      .prize-active { @apply ring-4 ring-primary scale-110 bg-primary/10; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-light to-secondary min-h-screen flex flex-col items-center">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <header class="text-center mb-8 w-full">
      <h1 class="text-[clamp(2rem,4vw,3rem)] font-bold text-dark mb-2">球球联动限定抽奖</h1>
      <p class="text-gray-600 mb-6">活动时间: <span class="text-primary font-semibold">2025年XX月XX日 - 2025年XX月XX日</span></p>
      <div class="bg-gray-100/70 p-3 rounded-lg inline-block">
        <p class="text-sm text-gray-600"><i class="fa fa-info-circle text-primary mr-1"></i>每日可抽奖3次，最多可获得3个兑换码！</p>
      </div>
    </header>

    <main class="flex flex-col items-center w-full">
      <!-- 九宫格奖品区：给每个卡片加固定索引，确保动画顺序正确 -->
      <div class="grid grid-cols-3 gap-3 w-full max-w-md mb-8">
        <div class="prize-card" data-index="0" data-prize="3888金蘑菇"><img src="images/prize/金蘑菇.png" alt="金蘑菇" class="w-16 h-16 mb-1"><p class="text-dark font-semibold">金蘑菇</p><p class="text-gray-600 text-sm">3888个</p></div>
        <div class="prize-card" data-index="1" data-prize="365天年卡会员"><img src="images/prize/月卡会员.png" alt="年卡会员" class="w-16 h-16 mb-1"><p class="text-dark font-semibold">年卡会员</p><p class="text-gray-600 text-sm">365天</p></div>
        <div class="prize-card" data-index="2" data-prize="666龙晶"><img src="images/prize/龙晶.png" alt="龙晶" class="w-16 h-16 mb-1"><p class="text-dark font-semibold">龙晶</p><p class="text-gray-600 text-sm">666个</p></div>
        <div class="prize-card" data-index="7" data-prize="99超大钥匙"><img src="images/prize/超大钥匙.png" alt="超大钥匙" class="w-16 h-16 mb-1"><p class="text-dark font-semibold">超大钥匙</p><p class="text-gray-600 text-sm">99个</p></div>
        <div class="flex items-center justify-center"><button id="spin-btn" class="spin-btn">开始抽奖</button></div>
        <div class="prize-card" data-index="3" data-prize="嘉年华孢子1个"><img src="images/prize/嘉年华孢子.png" alt="嘉年华孢子" class="w-16 h-16 mb-1"><p class="text-dark font-semibold">嘉年华孢子</p><p class="text-gray-600 text-sm">1个</p></div>
        <div class="prize-card" data-index="6" data-prize="980金蘑菇"><img src="images/prize/金蘑菇.png" alt="金蘑菇" class="w-16 h-16 mb-1"><p class="text-dark font-semibold">金蘑菇</p><p class="text-gray-600 text-sm">980个</p></div>
        <div class="prize-card" data-index="5" data-prize="黑暗之手皮肤"><img src="images/prize/黑暗之手.png" alt="黑暗之手" class="w-16 h-16 mb-1"><p class="text-dark font-semibold">黑暗之手</p><p class="text-gray-600 text-sm">皮肤</p></div>
        <div class="prize-card" data-index="4" data-prize="15超大钥匙"><img src="images/prize/超大钥匙.png" alt="超大钥匙" class="w-16 h-16 mb-1"><p class="text-dark font-semibold">超大钥匙</p><p class="text-gray-600 text-sm">15个</p></div>
      </div>

      <div class="flex items-center justify-between w-full max-w-md mb-8">
        <div class="flex items-center"><i class="fa fa-star text-accent text-xl mr-2"></i><span class="text-dark font-semibold">今日剩余次数: <span id="remain-count">3</span></span></div>
        <button id="history-btn" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-2 px-4 rounded transition-colors"><i class="fa fa-history mr-1"></i>我的奖品</button>
      </div>
      
      <div class="w-full max-w-md mb-8">
        <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="count-progress" class="h-full bg-primary rounded-full" style="width: 100%"></div></div>
        <div id="no-chances" class="text-center text-red-500 font-semibold mt-2 hidden"><i class="fa fa-exclamation-circle mr-1"></i>今日抽奖次数已用尽！</div>
        <div id="max-codes" class="text-center text-red-500 font-semibold mt-2 hidden"><i class="fa fa-exclamation-circle mr-1"></i>今日已获得3个兑换码，明日再来！</div>
      </div>

      <div id="result-panel" class="result-card hidden w-full max-w-md mb-8">
        <h2 class="text-2xl font-bold text-primary mb-4">恭喜中奖！</h2>
        <img id="prize-img" src="" alt="中奖奖品" class="w-24 h-24 mx-auto mb-4">
        <p class="text-xl mb-6" id="prize-name">获得神秘奖励</p>
        <div class="bg-gray-100 p-3 rounded-lg mb-4"><p class="text-gray-600 mb-2">礼包兑换码</p><div class="flex items-center justify-center"><span id="code" class="text-lg font-mono font-bold bg-white px-3 py-1 rounded">XXXX-XXXX-XXXX</span></div></div>
        <button id="copy-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded transition-colors"><i class="fa fa-copy mr-1"></i>复制兑换码</button>
      </div>
    </main>

    <footer class="mt-12 text-center text-gray-500 text-sm w-full"><p>© 2025 球球联动限定活动 版权所有</p><p class="mt-1">本活动最终解释权归主办方所有</p></footer>
  </div>

  <div id="history-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="history-modal-content">
      <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-dark">我的奖品</h3><button id="close-history" class="text-gray-500 hover:text-gray-700"><i class="fa fa-times text-xl"></i></button></div>
      <div id="history-list" class="space-y-2"><div class="text-center text-gray-500 py-6" id="empty-history"><i class="fa fa-inbox text-4xl mb-2"></i><p>暂无抽奖记录</p></div></div>
    </div>
  </div>

  <script>
    // 奖品配置（与页面data-prize完全一致）
    const prizes = [
      { name: "3888金蘑菇", image: "images/prize/金蘑菇.png", value: 3888 },
      { name: "365天年卡会员", image: "images/prize/月卡会员.png", value: 365 },
      { name: "666龙晶", image: "images/prize/龙晶.png", value: 666 },
      { name: "嘉年华孢子1个", image: "images/prize/嘉年华孢子.png", value: 1 },
      { name: "15超大钥匙", image: "images/prize/超大钥匙.png", value: 15 },
      { name: "黑暗之手皮肤", image: "images/prize/黑暗之手.png", value: 1 },
      { name: "980金蘑菇", image: "images/prize/金蘑菇.png", value: 980 },
      { name: "99超大钥匙", image: "images/prize/超大钥匙.png", value: 99 }
    ];

    // 关键修复：动画旋转顺序（按页面data-index顺时针排列，确保视觉连贯）
    const spinOrder = [0, 1, 2, 3, 4, 5, 6, 7];
    const STORAGE_KEY_HISTORY = 'drawHistory';
    const STORAGE_KEY_DAILY_INFO = 'drawDailyInfo';
    let drawHistory = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];

    // 工具函数
    const generateCode = () => Array.from({length: 4}, () => Array.from({length: 4}, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random() * 36)]).join('')).join('-');
    const getToday = () => new Date().toISOString().split('T')[0];
    const resetAllHighlights = () => document.querySelectorAll('.prize-card').forEach(card => card.classList.remove('prize-active'));

    // 本地存储操作
    const checkAndInitDailyInfo = () => {
        const today = getToday();
        let dailyInfo = JSON.parse(localStorage.getItem(STORAGE_KEY_DAILY_INFO)) || {};
        if (dailyInfo.date !== today) {
            dailyInfo = { date: today, remainingSpins: 3 };
            localStorage.setItem(STORAGE_KEY_DAILY_INFO, JSON.stringify(dailyInfo));
        }
        return dailyInfo;
    };
    const updateDailyRemainingSpins = (newCount) => {
        let dailyInfo = checkAndInitDailyInfo();
        dailyInfo.remainingSpins = newCount;
        localStorage.setItem(STORAGE_KEY_DAILY_INFO, JSON.stringify(dailyInfo));
    };
    const getTodayCodeCount = () => drawHistory.filter(item => item.date === getToday()).length;

    // 更新抽奖记录
    const updateHistoryList = () => {
      const historyList = document.getElementById('history-list');
      const emptyHistory = document.getElementById('empty-history');
      if (drawHistory.length === 0) {
        emptyHistory.classList.remove('hidden');
        return;
      }
      emptyHistory.classList.add('hidden');
      historyList.innerHTML = drawHistory.map(item => {
        const prizeInfo = prizes.find(p => p.name === item.prize) || { image: 'images/prize/default.png' };
        return `
          <div class="history-item">
            <div class="flex items-center"><img src="${prizeInfo.image}" alt="${item.prize}" class="w-10 h-10 rounded mr-3"><div><p class="font-semibold">${item.prize}</p><p class="text-sm text-gray-500">${item.date} ${item.time}</p></div></div>
            <div class="text-right"><p class="font-mono text-sm">${item.code}</p><button class="copy-history-code text-secondary hover:text-secondary/80 text-sm mt-1" data-code="${item.code}"><i class="fa fa-copy mr-1"></i>复制</button></div>
          </div>`;
      }).join('');
      document.querySelectorAll('.copy-history-code').forEach(btn => btn.addEventListener('click', (e) => {
        navigator.clipboard.writeText(e.currentTarget.dataset.code).then(() => {
          const originalHTML = e.currentTarget.innerHTML;
          e.currentTarget.innerHTML = '<i class="fa fa-check mr-1"></i>已复制';
          e.currentTarget.classList.add('text-green-500');
          setTimeout(() => { e.currentTarget.innerHTML = originalHTML; e.currentTarget.classList.remove('text-green-500'); }, 2000);
        });
      }));
    };

    // 最终简化版动画：只做"循环高亮+直接停在目标"，无复杂计算
    const startDrawAnimation = (targetPrizeName) => {
        return new Promise((resolve) => {
            resetAllHighlights();
            // 找到目标奖品的索引（通过data-prize匹配）
            const targetCard = document.querySelector(`[data-prize="${targetPrizeName}"]`);
            const targetIndex = parseInt(targetCard.dataset.index);
            
            let currentSpinIndex = 0; // 从第一个索引开始循环
            let spinSpeed = 80; // 初始速度
            let spinCount = 0; // 循环次数计数
            const maxFastSpins = 3; // 快速循环3圈后减速
            const totalSpins = maxFastSpins * spinOrder.length; // 快速循环总步数

            // 动画循环（用setTimeout替代setInterval，避免累计误差）
            const spinLoop = () => {
                // 移除上一个高亮
                const prevCard = document.querySelector(`[data-index="${spinOrder[currentSpinIndex % spinOrder.length]}"]`);
                if (prevCard) prevCard.classList.remove('prize-active');
                
                // 计算下一个索引
                currentSpinIndex++;
                const nextIndex = spinOrder[currentSpinIndex % spinOrder.length];
                const nextCard = document.querySelector(`[data-index="${nextIndex}"]`);
                
                // 高亮下一个
                if (nextCard) nextCard.classList.add('prize-active');
                
                // 加速阶段：前3圈快速
                if (spinCount < totalSpins) {
                    spinCount++;
                    setTimeout(spinLoop, spinSpeed);
                } 
                // 减速阶段：最后1圈逐渐变慢
                else if (nextIndex !== targetIndex) {
                    spinSpeed += 50; // 每步减速50ms
                    setTimeout(spinLoop, spinSpeed);
                } 
                // 到达目标：停止动画
                else {
                    setTimeout(() => {
                        resolve(); // 动画完成，返回结果
                    }, 800); // 保持高亮0.8秒，让用户看清
                }
            };

            // 启动动画
            spinLoop();
        });
    };

    // 页面初始化
    document.addEventListener('DOMContentLoaded', () => {
        const spinBtn = document.getElementById('spin-btn');
        const resultPanel = document.getElementById('result-panel');
        const prizeImg = document.getElementById('prize-img');
        const prizeNameEl = document.getElementById('prize-name');
        const codeEl = document.getElementById('code');
        const remainCountEl = document.getElementById('remain-count');
        const countProgress = document.getElementById('count-progress');
        const noChancesEl = document.getElementById('no-chances');
        const maxCodesEl = document.getElementById('max-codes');

        let dailyInfo = checkAndInitDailyInfo();
        let remainingSpins = dailyInfo.remainingSpins;
        let isSpinning = false; // 防止重复点击

        // 更新UI状态
        const updateUI = () => {
            remainCountEl.textContent = remainingSpins;
            countProgress.style.width = `${(remainingSpins / 3) * 100}%`;

            const todayCodeCount = getTodayCodeCount();
            if (isSpinning) {
                spinBtn.disabled = true;
                spinBtn.textContent = '抽奖中...';
                return;
            }

            if (todayCodeCount >= 3) {
                spinBtn.disabled = true;
                spinBtn.textContent = '今日兑换码已达上限';
                maxCodesEl.classList.remove('hidden');
                noChancesEl.classList.add('hidden');
            } else if (remainingSpins <= 0) {
                spinBtn.disabled = true;
                spinBtn.textContent = '次数已用尽';
                noChancesEl.classList.remove('hidden');
                maxCodesEl.classList.add('hidden');
            } else {
                spinBtn.disabled = false;
                spinBtn.textContent = '开始抽奖';
                noChancesEl.classList.add('hidden');
                maxCodesEl.classList.add('hidden');
            }
        };

        updateHistoryList();
        updateUI();

        // 抽奖按钮点击事件
        spinBtn.addEventListener('click', async () => {
            if (spinBtn.disabled || isSpinning) return;

            const todayCodeCount = getTodayCodeCount();
            if (todayCodeCount >= 3 || remainingSpins <= 0) {
                updateUI();
                return;
            }

            // 标记抽奖中状态
            isSpinning = true;
            updateUI();

            // 更新抽奖次数
            remainingSpins--;
            updateDailyRemainingSpins(remainingSpins);

            // 随机选择中奖奖品（确保一定能找到对应的卡片）
            const randomPrizeIndex = Math.floor(Math.random() * prizes.length);
            const prize = prizes[randomPrizeIndex];
            const code = generateCode();

            try {
                // 执行简化版动画（无复杂计算，不会出错）
                await startDrawAnimation(prize.name);

                // 显示中奖结果
                prizeImg.src = prize.image;
                prizeNameEl.textContent = `获得 ${prize.name}`;
                codeEl.textContent = code;
                resultPanel.classList.remove('hidden');

                // 记录抽奖历史
                drawHistory.unshift({ 
                    prize: prize.name, 
                    code, 
                    date: getToday(), 
                    time: new Date().toLocaleTimeString() 
                });
                if (drawHistory.length > 10) drawHistory.pop();
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(drawHistory));
                updateHistoryList();

            } catch (error) {
                console.error("抽奖异常:", error);
                alert("抽奖完成！请查看我的奖品记录~");
            } finally {
                // 无论成功失败，都恢复状态
                isSpinning = false;
                resetAllHighlights();
                updateUI();
            }
        });

        // 复制兑换码
        document.getElementById('copy-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(codeEl.textContent).then(() => {
                const btn = document.getElementById('copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa fa-check mr-1"></i>已复制';
                btn.classList.add('bg-green-500');
                setTimeout(() => { btn.innerHTML = originalText; btn.classList.remove('bg-green-500'); }, 2000);
            });
        });

        // 抽奖记录弹窗
        const historyModal = document.getElementById('history-modal');
        const historyModalContent = document.getElementById('history-modal-content');
        document.getElementById('history-btn').addEventListener('click', () => {
            historyModal.classList.remove('hidden');
            setTimeout(() => { 
                historyModalContent.classList.remove('scale-95', 'opacity-0'); 
                historyModalContent.classList.add('scale-100', 'opacity-100'); 
            }, 10);
        });
        document.getElementById('close-history').addEventListener('click', () => {
            historyModalContent.classList.remove('scale-100', 'opacity-100');
            historyModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { historyModal.classList.add('hidden'); }, 300);
        });
        historyModal.addEventListener('click', (e) => { 
            if (e.target === historyModal) document.getElementById('close-history').click(); 
        });
    });
  </script>
</body>
</html>
